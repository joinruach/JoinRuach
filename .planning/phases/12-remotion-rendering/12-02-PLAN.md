---
phase: 12-remotion-rendering
plan: 02
type: execute
---

<objective>
Add caption overlays and chapter markers to create viewer-ready rendered videos.

Purpose: Layer subtitles and chapter graphics on top of multi-camera cuts, creating professional, watchable output ready for distribution.

Output: Enhanced Remotion composition with captions synced to speech and chapter lower-thirds.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/phases/12-remotion-rendering/12-01-SUMMARY.md
@ruach-video-renderer/src/compositions/MultiCamComposition.tsx

**From Plan 1:**
- MultiCamComposition renders camera cuts correctly
- EDL loader utilities available
- Sequence-based rendering working

**From Phase 10:**
- Aligned transcripts with speaker labels
- Word-level timestamps per camera
- Available via: GET /recording-sessions/:id/transcript

**From Phase 11:**
- Chapter markers in EDL (AI-generated titles)
- Available in edl.tracks.chapters

**Caption Requirements:**
- Sync with speech (word or segment level)
- Speaker labels (optional toggle)
- Safe margins (bottom 10% of frame)
- Readable typography
- Background for contrast

**Chapter Marker Requirements:**
- Display at chapter start (first 2-3 seconds)
- Lower third graphic with title
- Fade in/out animation
- Clean, professional styling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create caption overlay component</name>
  <files>ruach-video-renderer/src/components/CaptionsLayer.tsx, ruach-video-renderer/src/utils/caption-loader.ts</files>
  <action>Create caption system that syncs with video:

  caption-loader.ts utilities:
  ```typescript
  // Fetch transcript from Phase 10 API
  async function fetchTranscript(sessionId: string): Promise<Transcript>

  // Get caption text for current time
  function getCaptionAtTime(transcript: Transcript, camera: string, timeMs: number): CaptionSegment | null

  // Format caption with speaker label
  function formatCaption(segment: CaptionSegment, showSpeaker: boolean): string
  ```

  CaptionsLayer.tsx component:
  ```typescript
  export type CaptionsLayerProps = {
    sessionId: string;
    currentCamera: string;
    currentTimeMs: number;
    showSpeaker?: boolean;
    style?: CaptionStyle;
  };

  export const CaptionsLayer: React.FC<CaptionsLayerProps> = ({...}) => {
    const [transcript, setTranscript] = useState<Transcript | null>(null);

    useEffect(() => {
      fetchTranscript(sessionId).then(setTranscript);
    }, [sessionId]);

    const caption = getCaptionAtTime(transcript, currentCamera, currentTimeMs);

    if (!caption) return null;

    return (
      <AbsoluteFill style={{ pointerEvents: 'none' }}>
        <div style={{
          position: 'absolute',
          bottom: '10%',
          left: '10%',
          right: '10%',
          textAlign: 'center',
          fontSize: 48,
          fontWeight: 600,
          color: 'white',
          textShadow: '0 2px 10px rgba(0,0,0,0.8)',
          backgroundColor: 'rgba(0,0,0,0.7)',
          padding: '16px 32px',
          borderRadius: 8,
        }}>
          {showSpeaker && <span style={{ color: '#fbbf24' }}>{caption.speaker}: </span>}
          {caption.text}
        </div>
      </AbsoluteFill>
    );
  };
  ```

  Caption Strategy:
  - Use segment-level (not word-level) for readability
  - Display 1-2 segments at a time (max 2 lines)
  - Speaker label in amber color
  - Black background with 70% opacity
  - Safe margins: 10% from bottom and sides
  - Text shadow for contrast on light backgrounds

  Don't implement word-by-word karaoke style (too complex for v1).</action>
  <verify>TypeScript compiles, CaptionsLayer renders without errors</verify>
  <done>Caption overlay system syncs with video and displays speaker text</done>
</task>

<task type="auto">
  <name>Task 2: Create chapter marker component</name>
  <files>ruach-video-renderer/src/components/ChapterMarker.tsx</files>
  <action>Create chapter lower-third that displays at chapter boundaries:

  ChapterMarker.tsx component:
  ```typescript
  export type ChapterMarkerProps = {
    chapter: Chapter;
    currentTimeMs: number;
    displayDurationMs?: number; // Default 3000 (3 seconds)
  };

  export const ChapterMarker: React.FC<ChapterMarkerProps> = ({
    chapter,
    currentTimeMs,
    displayDurationMs = 3000,
  }) => {
    const timeSinceStart = currentTimeMs - chapter.startMs;

    // Only show for first N seconds of chapter
    if (timeSinceStart < 0 || timeSinceStart > displayDurationMs) {
      return null;
    }

    // Fade in/out animation
    const fadeInDuration = 500;
    const fadeOutDuration = 500;
    let opacity = 1;

    if (timeSinceStart < fadeInDuration) {
      opacity = timeSinceStart / fadeInDuration;
    } else if (timeSinceStart > displayDurationMs - fadeOutDuration) {
      opacity = (displayDurationMs - timeSinceStart) / fadeOutDuration;
    }

    return (
      <AbsoluteFill style={{ pointerEvents: 'none' }}>
        <div style={{
          position: 'absolute',
          bottom: '20%',
          left: '5%',
          opacity,
          transition: 'opacity 0.3s ease',
        }}>
          <div style={{
            backgroundColor: 'rgba(0,0,0,0.85)',
            padding: '24px 48px',
            borderLeft: '6px solid #3b82f6',
            maxWidth: 600,
          }}>
            <div style={{
              fontSize: 16,
              color: '#93c5fd',
              fontWeight: 600,
              textTransform: 'uppercase',
              letterSpacing: 1.5,
              marginBottom: 8,
            }}>
              Chapter
            </div>
            <div style={{
              fontSize: 36,
              color: 'white',
              fontWeight: 700,
              lineHeight: 1.2,
            }}>
              {chapter.title}
            </div>
          </div>
        </div>
      </AbsoluteFill>
    );
  };
  ```

  Styling:
  - Lower third position (bottom 20%, left 5%)
  - Dark background with blue accent border
  - Fade in: 500ms
  - Display: 3 seconds
  - Fade out: 500ms
  - "Chapter" label in blue
  - Title in white, bold

  Clean, professional look matching modern video standards.</action>
  <verify>TypeScript compiles, ChapterMarker renders with fade animation</verify>
  <done>Chapter markers display at boundaries with professional styling</done>
</task>

<task type="auto">
  <name>Task 3: Integrate captions and chapters into MultiCamComposition</name>
  <files>ruach-video-renderer/src/compositions/MultiCamComposition.tsx</files>
  <action>Integrate caption and chapter layers into main composition:

  Add to MultiCamComposition:
  ```typescript
  import { CaptionsLayer } from '../components/CaptionsLayer';
  import { ChapterMarker } from '../components/ChapterMarker';
  import { useCurrentFrame, useVideoConfig } from 'remotion';
  import { framesToMs } from '../utils/edl-loader';

  // Inside component
  const frame = useCurrentFrame();
  const { fps } = useVideoConfig();
  const currentTimeMs = framesToMs(frame, fps);

  // Get current camera and chapter
  const currentCut = getCutAtTime(edl, currentTimeMs);
  const currentCamera = currentCut?.camera || edl.masterCamera;
  const currentChapter = getChapterAtTime(edl, currentTimeMs);

  return (
    <AbsoluteFill style={{ backgroundColor: 'black' }}>
      {/* Existing camera sequences */}
      {sequences.map((s) => (
        <Sequence key={s.key} from={s.from} durationInFrames={s.durationInFrames}>
          {s.node}
        </Sequence>
      ))}

      {/* Caption overlay */}
      <CaptionsLayer
        sessionId={sessionId}
        currentCamera={currentCamera}
        currentTimeMs={currentTimeMs}
        showSpeaker={true}
      />

      {/* Chapter markers */}
      {currentChapter && (
        <ChapterMarker
          chapter={currentChapter}
          currentTimeMs={currentTimeMs}
          displayDurationMs={3000}
        />
      )}

      {/* Existing debug overlay */}
      {debug && <DebugOverlay />}
    </AbsoluteFill>
  );
  ```

  Add props to composition:
  ```typescript
  export type MultiCamCompositionProps = {
    sessionId: string;
    cameraSources: Record<string, string>;
    debug?: boolean;
    showCaptions?: boolean;      // New
    showChapters?: boolean;       // New
    showSpeakerLabels?: boolean;  // New
  };
  ```

  Layer order (bottom to top):
  1. Video (camera cuts)
  2. Captions
  3. Chapter markers
  4. Debug overlay (if enabled)

  All overlays use `pointerEvents: 'none'` to avoid blocking video.</action>
  <verify>TypeScript compiles, composition renders with all layers</verify>
  <done>Complete viewer-ready composition with captions and chapters</done>
</task>

<task type="auto">
  <name>Task 4: Define audio strategy</name>
  <files>ruach-video-renderer/src/compositions/MultiCamComposition.tsx</files>
  <action>Implement simple audio strategy for program audio:

  Decision: Use master camera audio (same as EDL master camera)

  Rationale:
  - Master camera has best audio (Phase 9 selection criteria)
  - Consistent with EDL source of truth
  - No complex mixing needed for v1
  - Can upgrade to "best mic" selection later

  Implementation:
  ```typescript
  // In video rendering, set volume based on camera
  <Video
    src={resolveVideoSrc(src)}
    startFrom={startFrom}
    endAt={startFrom + durationFrames}
    volume={cameraId === edl.masterCamera ? 1 : 0}
  />
  ```

  This ensures:
  - Only master camera audio plays
  - No echo/overlap between cameras
  - Consistent audio throughout
  - Simple to understand and debug

  Future enhancement: Add "audioSource" field to EDL for explicit audio routing.
  </action>
  <verify>Audio plays from master camera only, no overlaps</verify>
  <done>Simple, deterministic audio strategy implemented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CaptionsLayer component renders synced text
- [ ] ChapterMarker component shows at boundaries
- [ ] MultiCamComposition integrates both layers
- [ ] Audio plays from master camera only
- [ ] TypeScript compiles without errors
- [ ] Layers stack correctly (video → captions → chapters → debug)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Captions sync with speech
- Chapter markers appear at boundaries
- Audio strategy is simple and deterministic
- Composition is "viewer-ready" (watchable, professional)
- Ready for Remotion Studio testing
</success_criteria>

<output>
After completion, create `.planning/phases/12-remotion-rendering/12-02-SUMMARY.md`:

# Phase 12 Plan 2: Captions & Chapters Summary

**Viewer-ready video composition**

## Accomplishments

- Created caption overlay system synced with Phase 10 transcripts
- Built chapter marker lower-thirds with fade animations
- Integrated layers into MultiCamComposition
- Defined simple audio strategy (master camera)
- Complete professional rendering pipeline

## Next Step

Ready for Remotion Studio testing and Phase 12 comprehensive summary.
</output>
