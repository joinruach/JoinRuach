---
phase: 12-remotion-rendering
plan: 01
type: execute
---

<objective>
Set up Remotion project and create video composition that consumes CanonicalEDL for multi-camera rendering.

Purpose: Enable automated video rendering from Phase 11 EDLs, generating final multi-camera videos with cuts, chapters, and captions.

Output: Working Remotion composition that renders locked EDLs to video files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/phases/11-edl-generation/11-SUMMARY.md
@ruach-ministries-backend/src/types/canonical-edl.ts

**From Phase 11:**
- CanonicalEDL JSON with camera cuts and chapters
- Camera sources with mezzanine URLs and offsets
- Locked EDLs ready for rendering (immutable)
- REST API: GET /recording-sessions/:id/edl

**From Phase 10:**
- Aligned transcripts with speaker labels
- SRT/VTT subtitle files available per camera

**From Phase 9:**
- Mezzanine ProRes files (r2_mezzanine_url)
- Sync offsets applied in EDL sources

**Remotion Requirements:**
- Video composition framework (React-based)
- Consumes CanonicalEDL JSON
- Renders multi-camera cuts with transitions
- Overlays subtitles/captions
- Exports to MP4/ProRes

**Architecture Decision:**
Create separate `ruach-video-renderer` package in monorepo for Remotion composition. Keep rendering logic separate from Strapi backend for scalability and cloud rendering.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Remotion package in monorepo</name>
  <files>ruach-video-renderer/package.json, ruach-video-renderer/remotion.config.ts</files>
  <action>Create new Remotion package in monorepo:

  1. Create directory: ruach-video-renderer/
  2. Initialize with: npm init -y
  3. Install Remotion: pnpm add remotion @remotion/cli @remotion/lambda
  4. Install dependencies: pnpm add @remotion/player react react-dom
  5. Install types: pnpm add -D @types/react @types/react-dom typescript

  Create remotion.config.ts:
  ```typescript
  import { Config } from "@remotion/cli/config";

  Config.setVideoImageFormat("jpeg");
  Config.setOverwriteOutput(true);
  Config.setConcurrency(4);
  ```

  Create tsconfig.json:
  ```json
  {
    "compilerOptions": {
      "target": "ES2022",
      "module": "ESNext",
      "jsx": "react-jsx",
      "moduleResolution": "node",
      "esModuleInterop": true,
      "skipLibCheck": true,
      "strict": true
    }
  }
  ```

  Add scripts to package.json:
  ```json
  {
    "scripts": {
      "dev": "remotion studio",
      "build": "remotion render",
      "preview": "remotion preview"
    }
  }
  ```

  Create src/ directory structure:
  - src/Root.tsx (Remotion root)
  - src/compositions/ (video compositions)
  - src/types/ (TypeScript types)
  - src/utils/ (helpers)
  </action>
  <verify>pnpm install succeeds, remotion.config.ts exists, TypeScript compiles</verify>
  <done>Remotion package initialized with proper configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create EDL types and utilities</name>
  <files>ruach-video-renderer/src/types/edl.ts, ruach-video-renderer/src/utils/edl-loader.ts</files>
  <action>Copy CanonicalEDL types and create loader utilities:

  1. Copy types from Phase 11:
     - CanonicalEDL, Cut, CameraSource, Chapter, etc.

  2. Create EDL loader utility:
     - fetchEDL(sessionId): Fetch from Strapi API
     - validateEDL(edl): Basic runtime validation
     - getCameraAtTime(edl, timeMs): Get active camera for timestamp
     - getChapterAtTime(edl, timeMs): Get current chapter

  3. Create video utilities:
     - calculateCameraTime(cutTimeMs, cameraOffset): Apply offset
     - getVideoUrl(source): Get mezzanine URL for camera

  Keep utilities pure functions (no React) for testability.</action>
  <verify>TypeScript compiles, utilities export correctly</verify>
  <done>EDL types and loader utilities ready for composition</done>
</task>

<task type="auto">
  <name>Task 3: Create multi-camera video composition</name>
  <files>ruach-video-renderer/src/compositions/MultiCamComposition.tsx</files>
  <action>Create Remotion composition that renders CanonicalEDL:

  Main composition:
  ```typescript
  import { Composition } from "remotion";
  import { MultiCamVideo } from "./MultiCamVideo";

  export const MultiCamComposition = () => {
    return (
      <Composition
        id="MultiCamVideo"
        component={MultiCamVideo}
        durationInFrames={/* from EDL */}
        fps={30}
        width={1920}
        height={1080}
        defaultProps={{
          edlUrl: "http://localhost:1337/api/recording-sessions/123/edl"
        }}
      />
    );
  };
  ```

  MultiCamVideo component:
  ```typescript
  import { AbsoluteFill, useCurrentFrame, Video } from "remotion";

  export const MultiCamVideo = ({ edlUrl }) => {
    const [edl, setEdl] = useState<CanonicalEDL | null>(null);
    const frame = useCurrentFrame();
    const fps = useVideoConfig().fps;
    const timeMs = (frame / fps) * 1000;

    useEffect(() => {
      // Fetch EDL on mount
      fetchEDL(edlUrl).then(setEdl);
    }, [edlUrl]);

    if (!edl) return <AbsoluteFill>Loading...</AbsoluteFill>;

    // Get active camera for current time
    const activeCamera = getCameraAtTime(edl, timeMs);
    const cameraSource = edl.sources[activeCamera];

    // Calculate camera-specific time with offset
    const cameraTime = calculateCameraTime(timeMs, cameraSource.offsetMs);

    return (
      <AbsoluteFill>
        <Video
          src={cameraSource.mezzanineUrl}
          startFrom={Math.max(0, Math.floor((cameraTime / 1000) * fps))}
          volume={1}
        />
      </AbsoluteFill>
    );
  };
  ```

  Handle cut transitions:
  - Use Remotion's <Sequence> for each cut
  - Calculate startFrom frame for each camera based on offset
  - Ensure smooth transitions (no gaps/overlaps)
  </action>
  <verify>Composition renders in Remotion Studio, video plays with cuts</verify>
  <done>Multi-camera composition renders EDL-based video</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ruach-video-renderer package exists
- [ ] remotion.config.ts configured
- [ ] EDL types and utilities created
- [ ] MultiCamComposition renders in Remotion Studio
- [ ] pnpm install succeeds across monorepo
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Remotion package initialized
- Can load CanonicalEDL from API
- Multi-camera composition renders with cuts
- Ready for Phase 12 Plan 2 (Captions + Chapters overlay)
</success_criteria>

<output>
After completion, create `.planning/phases/12-remotion-rendering/12-01-SUMMARY.md`:

# Phase 12 Plan 1: Remotion Setup & Multi-Camera Composition Summary

**Remotion foundation with EDL-based rendering**

## Accomplishments

- Initialized ruach-video-renderer package with Remotion
- Created EDL types and loader utilities
- Built multi-camera video composition consuming CanonicalEDL
- Renders camera cuts with proper timing and offsets

## Files Created/Modified

- `ruach-video-renderer/package.json` - Remotion package
- `ruach-video-renderer/remotion.config.ts` - Remotion configuration
- `ruach-video-renderer/src/types/edl.ts` - CanonicalEDL types
- `ruach-video-renderer/src/utils/edl-loader.ts` - EDL loading utilities
- `ruach-video-renderer/src/compositions/MultiCamComposition.tsx` - Main composition

## Next Step

Ready for 12-02-PLAN.md: Subtitle overlays, chapter markers, and export configuration
</output>
