---
phase: 10-transcript-alignment
plan: 02
type: execute
---

<objective>
Integrate transcription services with Strapi and create REST API endpoints.

Purpose: Persist aligned transcripts in Strapi, generate SRT/VTT for video players, and expose transcription workflow via REST API.

Output: Working API endpoints for triggering transcription, retrieving transcripts, and downloading SRT/VTT files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/phases/10-transcript-alignment/10-RESEARCH.md
@.planning/phases/10-transcript-alignment/10-01-SUMMARY.md
@ruach-ministries-backend/src/api/recording-session/content-types/recording-session/schema.json
@ruach-ministries-backend/src/api/recording-session/controllers/sync-controller.ts
@ruach-ministries-backend/src/api/recording-session/routes/sync-routes.ts
@ruach-ministries-backend/src/services/transcription-service.ts
@ruach-ministries-backend/src/services/transcript-alignment-service.ts

**From Plan 1:**
- transcription-service.ts provides transcribeSession()
- transcript-alignment-service.ts provides alignTranscripts()
- Both services tested and working

**API design pattern (from Phase 9 sync routes):**
- POST /recording-sessions/:id/transcript/compute - Trigger transcription
- GET /recording-sessions/:id/transcript - Get transcript JSON
- GET /recording-sessions/:id/transcript/srt/:camera - Get SRT file for camera
- GET /recording-sessions/:id/transcript/vtt/:camera - Get VTT file for camera

**Don't hand-roll (from research):**
- Subtitle format conversion - use subtitle.js stringify()
- Speaker label formatting - use AssemblyAI output directly
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subtitle generation service</name>
  <files>ruach-ministries-backend/src/services/subtitle-generator.ts</files>
  <action>Create service that converts JSON transcript segments to SRT/VTT using subtitle.js:
  1. Accepts TranscriptSegment[] for a single camera
  2. Converts to subtitle.js format with speaker labels
  3. Exports generateSRT() and generateVTT() functions

  Implementation:
  - Import { stringify } from 'subtitle'
  - Convert segments to subtitle cues: { type: 'cue', data: { start, end, text } }
  - For SRT: text = `[${speaker}] ${segment.text}` (speaker prefix)
  - For VTT: text = `<v ${speaker}>${segment.text}</v>` (VTT voice tags)
  - Call stringify(cues, { format: 'SRT' }) or stringify(cues, { format: 'WebVTT' })

  Return type: string (SRT or VTT content)

  Don't manually format timestamps or cue numbers - subtitle.js handles this correctly.</action>
  <verify>TypeScript compiles, service exports generateSRT and generateVTT functions</verify>
  <done>Service can convert transcript segments to valid SRT and VTT strings with speaker labels</done>
</task>

<task type="auto">
  <name>Task 2: Create transcript Strapi service wrapper</name>
  <files>ruach-ministries-backend/src/api/recording-session/services/transcript-service.ts</files>
  <action>Create Strapi service that orchestrates transcription workflow:
  1. transcribeSession(sessionId):
     - Load session with populate: ['assets']
     - Call transcription-service.transcribeSession() for master audio
     - Call transcript-alignment-service.alignTranscripts() with sync offsets
     - Store aligned transcripts in session.transcript relation (library-transcription entity)
     - Calculate metadata: speakerCount, averageConfidence, lowConfidenceSegments
     - Update session status to 'transcribed'

  2. getTranscript(sessionId):
     - Load session with populate: ['transcript']
     - Return transcript data with aligned segments per camera

  3. getSubtitle(sessionId, camera, format):
     - Load transcript for session
     - Get segments for specified camera
     - Call subtitle-generator.generateSRT() or generateVTT()
     - Return subtitle string

  Storage structure:
  - library-transcription.masterTranscript = JSON.stringify(alignedTranscripts) // All cameras
  - library-transcription.speakerCount = unique speakers count
  - library-transcription.confidence = average confidence across all words
  - library-transcription.status = 'completed'

  Error handling: Wrap AssemblyAI API calls in try/catch, update session status to 'transcription-failed' on error.

  Follow Phase 9 sync-service.ts pattern for consistency.</action>
  <verify>TypeScript compiles, service exports transcribeSession, getTranscript, getSubtitle</verify>
  <done>Service integrates all Phase 10 components, stores transcripts in Strapi, generates subtitles</done>
</task>

<task type="auto">
  <name>Task 3: Create transcript controller and routes</name>
  <files>ruach-ministries-backend/src/api/recording-session/controllers/transcript-controller.ts, ruach-ministries-backend/src/api/recording-session/routes/transcript-routes.ts</files>
  <action>Create REST API controller and routes following Phase 9 sync-controller.ts pattern:

  Controller (transcript-controller.ts):
  - compute(ctx): POST /:id/transcript/compute
    - Calls transcript-service.transcribeSession(id)
    - Returns { success: true, data: { speakerCount, confidence, cameras: [...] } }

  - get(ctx): GET /:id/transcript
    - Calls transcript-service.getTranscript(id)
    - Returns { success: true, data: { sessionId, transcripts: {...} } }

  - getSRT(ctx): GET /:id/transcript/srt/:camera
    - Calls transcript-service.getSubtitle(id, camera, 'SRT')
    - Sets Content-Type: text/plain, Content-Disposition: attachment
    - Returns SRT file content

  - getVTT(ctx): GET /:id/transcript/vtt/:camera
    - Calls transcript-service.getSubtitle(id, camera, 'VTT')
    - Sets Content-Type: text/vtt, Content-Disposition: attachment
    - Returns VTT file content

  Routes (transcript-routes.ts):
  ```typescript
  export default {
    routes: [
      { method: 'POST', path: '/recording-sessions/:id/transcript/compute', handler: 'transcript-controller.compute' },
      { method: 'GET', path: '/recording-sessions/:id/transcript', handler: 'transcript-controller.get' },
      { method: 'GET', path: '/recording-sessions/:id/transcript/srt/:camera', handler: 'transcript-controller.getSRT' },
      { method: 'GET', path: '/recording-sessions/:id/transcript/vtt/:camera', handler: 'transcript-controller.getVTT' },
    ],
  };
  ```

  Error handling: Return ctx.badRequest() for missing params, ctx.notFound() for missing transcript.

  Follow sync-controller.ts and sync-routes.ts structure exactly for consistency.</action>
  <verify>TypeScript compiles, routes registered, curl to endpoints returns expected structure</verify>
  <done>API endpoints work for compute, get JSON, download SRT, download VTT</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm run build succeeds
- [ ] No TypeScript errors
- [ ] subtitle-generator.ts exports generateSRT and generateVTT
- [ ] transcript-service.ts (Strapi) orchestrates full workflow
- [ ] transcript-controller.ts handles all API routes
- [ ] transcript-routes.ts registers 4 routes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Transcripts stored in Strapi library-transcription
- SRT/VTT files generated correctly with speaker labels
- API endpoints functional and tested
- Phase 10 complete - ready for operator testing
</success_criteria>

<output>
After completion, create `.planning/phases/10-transcript-alignment/10-02-SUMMARY.md`:

# Phase 10 Plan 2: Strapi Integration & API Summary

**Complete transcription workflow with REST API**

## Accomplishments

- Created subtitle-generator.ts for SRT/VTT conversion
- Created transcript-service.ts (Strapi wrapper) orchestrating full workflow
- Created transcript-controller.ts and transcript-routes.ts for REST API
- Integrated with library-transcription entity for persistence
- Implemented SRT/VTT download with proper Content-Type headers

## Files Created/Modified

- `ruach-ministries-backend/src/services/subtitle-generator.ts` - SRT/VTT generation
- `ruach-ministries-backend/src/api/recording-session/services/transcript-service.ts` - Strapi workflow orchestration
- `ruach-ministries-backend/src/api/recording-session/controllers/transcript-controller.ts` - REST API controller
- `ruach-ministries-backend/src/api/recording-session/routes/transcript-routes.ts` - Route definitions

## Decisions Made

- Store all camera transcripts in single JSON field (masterTranscript) for atomic updates
- Use speaker labels in both SRT and VTT formats for clarity
- Follow Phase 9 sync API pattern for consistency

## Issues Encountered

[To be filled during execution]

## Next Phase Readiness

Phase 10 complete! Transcript alignment ready for integration with:
- Phase 11: EDL generation (use aligned timestamps for multi-camera editing)
- Phase 12: Remotion rendering (use transcripts for captions)
- Phase 13: Studio UI (display transcripts, allow corrections)

**Ready for production testing with real 3-camera sessions.**
</output>
