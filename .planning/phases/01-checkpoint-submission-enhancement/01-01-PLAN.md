---
phase: 01-checkpoint-submission-enhancement
plan: 01
type: execute
---

<objective>
Complete the checkpoint submission flow with word count tracking, enhanced dwell timer UI, and validation enforcement to ensure reflections meet formation requirements before submission.

Purpose: Enforce genuine engagement with formation content by requiring minimum word count (50 words) and dwell time (varies by checkpoint) before allowing submission. This prevents checkbox completion and encourages deeper reflection.

Output: Enhanced checkpoint form with live validation feedback, disabled submit button until requirements met, and draft persistence for recovery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing Code:**
@apps/ruach-next/src/app/[locale]/guidebook/awakening/[slug]/SectionView.tsx
@apps/ruach-next/src/app/[locale]/guidebook/awakening/[slug]/actions.ts

**Codebase Context:**
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/TESTING.md

**Current Implementation:**
The SectionView.tsx component already has:
- Basic dwell timer (starts on mount, hidden field in form)
- Minimum dwell time check (shows checkpoint after wait)
- Textarea for reflection input
- Server action submission (submitCheckpoint in actions.ts)

**What's Missing:**
- Word count tracker with live display
- 50-word minimum validation
- Submit button disabled until both requirements met
- Visual progress indicators for dwell time and word count
- Draft persistence to localStorage
- Clear validation error messages

**Requirements from PROJECT.md:**
- Word count tracker (minimum 50 words enforced)
- Dwell timer (minimum 2 minutes enforced) - already exists, needs UI enhancement
- Submit button disabled until requirements met
- Clean validation messages
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add word count validation and visual feedback</name>
  <files>apps/ruach-next/src/app/[locale]/guidebook/awakening/[slug]/SectionView.tsx</files>
  <action>
Add word count tracking to the checkpoint form:

1. Add state for reflection text and word count:
   ```typescript
   const [reflection, setReflection] = useState("");
   const [wordCount, setWordCount] = useState(0);
   ```

2. Create word counting function:
   ```typescript
   const countWords = (text: string): number => {
     return text.trim().split(/\s+/).filter(word => word.length > 0).length;
   };
   ```

3. Handle textarea changes:
   ```typescript
   const handleReflectionChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
     const text = e.target.value;
     setReflection(text);
     setWordCount(countWords(text));
   };
   ```

4. Add word count display below textarea:
   ```typescript
   <div className="flex items-center justify-between mt-2 text-sm">
     <span className={wordCount >= 50 ? "text-green-600 dark:text-green-400" : "text-neutral-500 dark:text-neutral-400"}>
       {wordCount} / 50 words {wordCount >= 50 ? "✓" : ""}
     </span>
     {wordCount < 50 && (
       <span className="text-amber-600 dark:text-amber-400">
         {50 - wordCount} more words needed
       </span>
     )}
   </div>
   ```

5. Update textarea to use controlled value:
   ```typescript
   <textarea
     value={reflection}
     onChange={handleReflectionChange}
     // ... existing props
   />
   ```

6. Add hidden field to form with reflection value (for server action):
   ```typescript
   <input type="hidden" name="reflection" value={reflection} />
   ```

Do NOT use any external word counting libraries - simple split on whitespace is sufficient. Do NOT count empty strings or whitespace-only text.
  </action>
  <verify>
1. Dev server running: `pnpm dev`
2. Navigate to /guidebook/awakening/covenant-introduction (or any section)
3. Type in reflection textarea
4. Verify word count updates live as you type
5. Verify "✓" appears when reaching 50 words
6. Verify "X more words needed" shows correctly
  </verify>
  <done>
- Word count displays and updates in real-time
- Color changes from neutral to green at 50+ words
- Checkmark appears at 50+ words
- "X more words needed" shows when under 50
- Controlled textarea value syncs with state
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance dwell timer UI and disable submit button</name>
  <files>apps/ruach-next/src/app/[locale]/guidebook/awakening/[slug]/SectionView.tsx</files>
  <action>
Enhance the dwell timer display and add submit button validation:

1. Add state for elapsed time:
   ```typescript
   const [elapsedSeconds, setElapsedSeconds] = useState(0);
   ```

2. Add interval to track elapsed time:
   ```typescript
   useEffect(() => {
     const interval = setInterval(() => {
       const elapsed = Math.floor((Date.now() - dwellStartTime) / 1000);
       setElapsedSeconds(elapsed);
     }, 1000);
     return () => clearInterval(interval);
   }, [dwellStartTime]);
   ```

3. Calculate if requirements are met:
   ```typescript
   const dwellRequirementMet = elapsedSeconds >= checkpoint.minimumDwellSeconds;
   const wordRequirementMet = wordCount >= 50;
   const canSubmit = dwellRequirementMet && wordRequirementMet && showCheckpoint;
   ```

4. Add dwell time progress display (replace existing timer text):
   ```typescript
   <div className="flex items-center gap-2 text-sm">
     <span className={dwellRequirementMet ? "text-green-600 dark:text-green-400" : "text-neutral-600 dark:text-neutral-400"}>
       Time: {elapsedSeconds}s / {checkpoint.minimumDwellSeconds}s {dwellRequirementMet ? "✓" : ""}
     </span>
   </div>
   ```

5. Update submit button with disabled state and visual feedback:
   ```typescript
   <button
     type="submit"
     disabled={!canSubmit || pending}
     className={`w-full rounded-xl px-6 py-4 font-bold text-white transition-all ${
       canSubmit && !pending
         ? "bg-amber-600 hover:bg-amber-700 cursor-pointer"
         : "bg-neutral-300 dark:bg-neutral-700 cursor-not-allowed opacity-50"
     }`}
   >
     {pending ? "Submitting..." : canSubmit ? "Submit Reflection" : "Complete Requirements to Submit"}
   </button>
   ```

6. Add requirements checklist above submit button:
   ```typescript
   <div className="mb-4 space-y-2 text-sm">
     <div className={dwellRequirementMet ? "text-green-600 dark:text-green-400" : "text-neutral-500"}>
       {dwellRequirementMet ? "✓" : "○"} Minimum reading time ({checkpoint.minimumDwellSeconds}s)
     </div>
     <div className={wordRequirementMet ? "text-green-600 dark:text-green-400" : "text-neutral-500"}>
       {wordRequirementMet ? "✓" : "○"} Minimum reflection length (50 words)
     </div>
   </div>
   ```

Do NOT remove the existing minimumWaitMs timer that controls showCheckpoint - that should remain. This task ADDS visual feedback for elapsed time.
  </action>
  <verify>
1. Navigate to guidebook section
2. Wait for checkpoint form to appear
3. Type less than 50 words - submit button should be disabled
4. Verify dwell time counter updates every second
5. Type 50+ words before dwell time met - submit button still disabled
6. Wait for dwell time to complete - submit button enables
7. Verify checkmarks appear when requirements met
8. Verify hover/cursor changes on disabled vs enabled button
  </verify>
  <done>
- Dwell timer shows elapsed time with live updates
- Submit button disabled until both requirements met
- Requirements checklist shows current status with checkmarks
- Button visual state changes (color, cursor, opacity) based on canSubmit
- Pending state shows "Submitting..." during form submission
- All validation happens client-side before server action
  </done>
</task>

<task type="auto">
  <name>Task 3: Add draft persistence to localStorage</name>
  <files>apps/ruach-next/src/app/[locale]/guidebook/awakening/[slug]/SectionView.tsx</files>
  <action>
Add localStorage persistence for draft reflections to prevent loss on accidental navigation or refresh:

1. Add localStorage key generator:
   ```typescript
   const getDraftKey = (sectionId: string) => `formation-draft-${sectionId}`;
   ```

2. Load draft on mount (before first render):
   ```typescript
   const [reflection, setReflection] = useState(() => {
     if (typeof window === "undefined") return "";
     const saved = localStorage.getItem(getDraftKey(section.id));
     return saved || "";
   });

   // Update initial word count
   const [wordCount, setWordCount] = useState(() => {
     if (typeof window === "undefined") return 0;
     const saved = localStorage.getItem(getDraftKey(section.id));
     return saved ? countWords(saved) : 0;
   });
   ```

3. Save draft on every change (debounced):
   ```typescript
   useEffect(() => {
     if (reflection) {
       localStorage.setItem(getDraftKey(section.id), reflection);
     }
   }, [reflection, section.id]);
   ```

4. Clear draft after successful submission:
   ```typescript
   useEffect(() => {
     if (state.ok && state.redirectTo) {
       localStorage.removeItem(getDraftKey(section.id));
       // Existing redirect logic continues
     }
   }, [state, section.id]);
   ```

5. Add "Clear Draft" button next to word count (optional but helpful):
   ```typescript
   <div className="flex items-center justify-between mt-2">
     <span className={/* existing word count styles */}>
       {wordCount} / 50 words {wordCount >= 50 ? "✓" : ""}
     </span>
     {reflection && (
       <button
         type="button"
         onClick={() => {
           setReflection("");
           setWordCount(0);
           localStorage.removeItem(getDraftKey(section.id));
         }}
         className="text-xs text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200"
       >
         Clear Draft
       </button>
     )}
   </div>
   ```

Use window !== "undefined" checks for SSR safety. Do NOT use debounce libraries - direct useEffect is fine for this simple case.
  </action>
  <verify>
1. Navigate to guidebook section
2. Type a draft reflection (20 words)
3. Refresh the page (or navigate away and back)
4. Verify draft text is restored in textarea
5. Verify word count reflects restored text
6. Type 50+ words, wait for dwell timer, submit
7. After successful submission redirect, verify draft is cleared
8. Navigate back to same section - textarea should be empty
9. Test "Clear Draft" button removes text and localStorage entry
  </verify>
  <done>
- Drafts save automatically to localStorage as user types
- Drafts restore on page load/refresh
- Word count updates correctly with restored draft
- Drafts clear after successful submission
- "Clear Draft" button works correctly
- No errors in SSR/hydration (window checks in place)
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm typecheck` passes with no errors in SectionView.tsx
- [ ] `pnpm build` succeeds without errors
- [ ] Submit button correctly disabled until BOTH requirements met
- [ ] Word count and dwell time display update in real-time
- [ ] Draft persistence works across page refresh
- [ ] Form submission still works correctly with validation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Word count validation enforces 50-word minimum
- Dwell timer shows live progress with visual feedback
- Submit button disabled until requirements met
- Draft persistence prevents accidental data loss
- No TypeScript errors introduced
- No regression in existing checkpoint submission flow
  </success_criteria>

<output>
After completion, create `.planning/phases/01-checkpoint-submission-enhancement/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Checkpoint Submission Enhancement Summary

**Enhanced checkpoint validation with word count tracking, dwell timer UI, and draft persistence**

## Accomplishments

- Added real-time word count validation (50-word minimum)
- Enhanced dwell timer with live progress display
- Implemented submit button disabled state with clear requirements checklist
- Added localStorage draft persistence to prevent data loss
- Created "Clear Draft" button for user control

## Files Created/Modified

- `apps/ruach-next/src/app/[locale]/guidebook/awakening/[slug]/SectionView.tsx` - Added word count tracking, enhanced timer UI, submit validation, draft persistence

## Decisions Made

- Used simple split-on-whitespace for word counting (no external library needed)
- Controlled component pattern for textarea (enables draft restoration)
- Client-side validation before server action (fast feedback)
- Auto-save drafts on every change (no debounce needed for small text)

## Issues Encountered

[Document any issues encountered during implementation, or "None"]

## Next Phase Readiness

Phase 1 complete. Ready for Phase 2: Voice Input & Transcription.

Requirements for Phase 2:
- Voice recording UI component
- OpenAI Whisper API integration
- Real-time transcription display
- Audio chunking for long recordings
</output>
