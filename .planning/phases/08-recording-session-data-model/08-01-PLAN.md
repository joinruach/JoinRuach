---
phase: 08-recording-session-data-model
plan: 01
type: execute
---

<objective>
Create Strapi v5 content type schemas for multi-camera recording session management, supporting 3+ camera angles, sync offsets, versioned EDL storage, and render job tracking.

Purpose: Establish the data foundation for the entire multi-camera video production pipeline. These schemas enable session grouping, media asset tracking, AI-generated edit decision lists, and render orchestration.

Output: Four new Strapi content types (recording-session, media-asset, edit-decision-list, render-job) with proper relations, indexes, and validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@.planning/phases/08-recording-session-data-model/08-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md
@ruach-ministries-backend/src/api/library-transcription/content-types/library-transcription/schema.json
@ruach-ministries-backend/src/api/media-summary/content-types/media-summary/schema.json

**Tech stack available:**
- Strapi v5.30.1 (headless CMS with PostgreSQL)
- TypeScript 5.3.3 strict mode
- pnpm monorepo with Turbo orchestration
- Existing content types: library-transcription, media-summary, discernment-analysis

**Established patterns:**
- Strapi content types: `src/api/{name}/content-types/{name}/schema.json`
- Schema structure: kind, collectionName, info, options, attributes
- Relations: manyToOne, oneToMany with proper inversedBy
- Status enumerations: pending → processing → completed/failed
- JSON fields for complex data (keyMoments, metadata)
- UID fields for external identification
- Indexes on frequently queried fields (status, relations)

**Constraining decisions:**
- v2.0 architecture: Content compilation, not destructive editing
- Versioned EDL workflow: v1 AI → v2 human-edited → v3 final
- Deterministic renders from (EDL + assets + version hash)
- Scripture overlays as first-class timeline events
- Separation of normalization from sync (Phase 9 requirement)

**Key architectural principles:**
- recording-session groups 3+ angles, stores sync offsets, tracks workflow state
- media-asset tracks each angle (Cam A/B/C + audio) with R2 URLs (original/proxy/mezzanine)
- edit-decision-list stores versioned JSON (cuts, overlays, chapters, shorts)
- render-job tracks BullMQ job execution, output URLs, status, progress
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create recording-session and media-asset schemas</name>
  <files>ruach-ministries-backend/src/api/recording-session/content-types/recording-session/schema.json, ruach-ministries-backend/src/api/media-asset/content-types/media-asset/schema.json</files>
  <action>
Create two Strapi content type schemas:

**recording-session schema:**
- collectionName: "recording_sessions"
- draftAndPublish: false
- Attributes:
  - sessionId: uid (required, unique, targetField: sessionId)
  - title: string (required, minLength: 1, maxLength: 255)
  - description: text
  - recordingDate: date
  - duration_ms: integer (min: 0, description: Total duration in milliseconds)
  - status: enumeration [draft, syncing, synced, editing, rendering, published, archived] (default: draft, required, index: true)
  - speakers: relation oneToMany to api::author.author (inversedBy: recordingSessions)
  - assets: relation oneToMany to api::media-asset.media-asset (inversedBy: recordingSession)
  - transcript: relation oneToOne to api::library-transcription.library-transcription
  - summary: relation oneToOne to api::media-summary.media-summary
  - syncOffsets_ms: json (description: Sync offsets for each angle {A: 0, B: 1830, C: -420}, default: {})
  - syncConfidence: json (description: Auto-sync confidence scores {B: 0.92, C: 0.81}, default: {})
  - anchorAngle: string (maxLength: 10, default: "A", description: Which angle is time=0)
  - metadata: json (description: Episode number, event type, technical notes, etc.)

**media-asset schema:**
- collectionName: "media_assets"
- draftAndPublish: false
- Attributes:
  - assetId: uid (required, unique, targetField: assetId)
  - recordingSession: relation manyToOne to api::recording-session.recording-session (inversedBy: assets, required, index: true)
  - type: enumeration [camera, audio, screen] (required, index: true)
  - angle: string (maxLength: 20, required, description: A|B|C|AUDIO|SCREEN)
  - r2_original_url: string (maxLength: 1024, required, description: Raw upload URL)
  - r2_proxy_url: string (maxLength: 1024, description: Low-res preview URL for Studio UI)
  - r2_mezzanine_url: string (maxLength: 1024, description: Normalized intermediate for rendering)
  - duration_ms: integer (min: 0, required)
  - fps: decimal (min: 0, max: 240, description: Frames per second)
  - resolution: string (maxLength: 20, description: 1920x1080, 3840x2160, etc.)
  - audioChannels: integer (min: 0, max: 32, description: Number of audio channels)
  - audioSampleRate: integer (min: 0, description: Sample rate in Hz, e.g., 48000)
  - audioFingerprint: text (description: Audio waveform signature for sync correlation)
  - waveformPeaks: json (description: Simplified waveform data for UI visualization, default: [])
  - fileSize_bytes: biginteger (min: 0, description: Original file size)
  - uploadedAt: datetime (required)
  - metadata: json (description: Codec, bitrate, camera model, etc.)

Use Strapi v5 patterns exactly as shown in library-transcription schema. Ensure all relations have proper inversedBy fields. Add indexes on status and relation fields for query performance. Use json type for complex structured data (not richtext or blocks).
  </action>
  <verify>
Files exist at specified paths. Both schemas have valid JSON syntax. Run: `cd ruach-ministries-backend && pnpm strapi ts:generate-types` should succeed without errors and regenerate TypeScript types.
  </verify>
  <done>
Two schema files created with proper Strapi v5 structure. TypeScript types regenerated successfully. No JSON syntax errors. All required fields marked, all relations have inversedBy, all indexes defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create edit-decision-list and render-job schemas</name>
  <files>ruach-ministries-backend/src/api/edit-decision-list/content-types/edit-decision-list/schema.json, ruach-ministries-backend/src/api/render-job/content-types/render-job/schema.json</files>
  <action>
Create two Strapi content type schemas:

**edit-decision-list schema:**
- collectionName: "edit_decision_lists"
- draftAndPublish: false
- Attributes:
  - edlId: uid (required, unique, targetField: edlId)
  - recordingSession: relation manyToOne to api::recording-session.recording-session (required, index: true)
  - version: integer (min: 1, required, default: 1, description: v1 AI, v2 human-edited, v3 final, etc.)
  - versionLabel: string (maxLength: 50, description: "AI Generated", "Human Refined", "Final", etc.)
  - createdBy: relation manyToOne to plugin::users-permissions.user (description: User who created/edited this version)
  - edlData: json (required, description: Full EDL structure with cuts, overlays, chapters, shorts)
  - cuts: json (description: Camera angle switches with timestamps, default: [])
  - overlays: json (description: Lower thirds, scripture cards, titles with timing, default: [])
  - chapters: json (description: Chapter markers with timestamps and titles, default: [])
  - shorts: json (description: Short-form segment definitions with start/end/format, default: [])
  - status: enumeration [draft, review, approved, superseded, archived] (default: draft, required, index: true)
  - approvedAt: datetime (description: When this version was approved for rendering)
  - approvedBy: relation manyToOne to plugin::users-permissions.user
  - versionHash: string (maxLength: 64, description: SHA256 hash of edlData for deterministic rendering)
  - parentVersion: relation manyToOne to api::edit-decision-list.edit-decision-list (inversedBy: childVersions, description: Previous EDL version this was based on)
  - childVersions: relation oneToMany to api::edit-decision-list.edit-decision-list (inversedBy: parentVersion)
  - metadata: json (description: AI model used, generation params, edit notes, etc.)

**render-job schema:**
- collectionName: "render_jobs"
- draftAndPublish: false
- Attributes:
  - jobId: uid (required, unique, targetField: jobId)
  - recordingSession: relation manyToOne to api::recording-session.recording-session (required, index: true)
  - edl: relation manyToOne to api::edit-decision-list.edit-decision-list (required, index: true)
  - format: enumeration [full_16_9, short_9_16, clip_1_1, thumbnail] (required, index: true)
  - status: enumeration [queued, processing, completed, failed, cancelled] (default: queued, required, index: true)
  - progress: decimal (min: 0, max: 1, default: 0, description: Render progress 0.0 to 1.0)
  - output_r2_url: string (maxLength: 1024, description: Final rendered video URL)
  - output_thumbnail_url: string (maxLength: 1024, description: Video thumbnail URL)
  - output_chapters_url: string (maxLength: 1024, description: Chapter markers JSON file URL)
  - output_subtitles_url: string (maxLength: 1024, description: Subtitles VTT file URL)
  - duration_ms: integer (min: 0, description: Rendered video duration)
  - fileSize_bytes: biginteger (min: 0, description: Output file size)
  - resolution: string (maxLength: 20, description: Output resolution, e.g., 1920x1080)
  - fps: decimal (min: 0, max: 240, description: Output frames per second)
  - bullmq_job_id: string (maxLength: 255, description: BullMQ job ID for tracking, index: true)
  - renderStartedAt: datetime
  - renderCompletedAt: datetime
  - errorMessage: text (description: Error details if status is failed)
  - metadata: json (description: Remotion version, render logs, performance metrics, etc.)

Use Strapi v5 patterns. Ensure EDL schema supports versioning with parentVersion/childVersions self-referential relation. Render job tracks BullMQ job ID for queue integration. All status fields indexed for dashboard queries.
  </action>
  <verify>
Files exist at specified paths. Both schemas have valid JSON syntax. Run: `cd ruach-ministries-backend && pnpm strapi ts:generate-types` should succeed and regenerate TypeScript types including the new content types.
  </verify>
  <done>
Two schema files created with proper Strapi v5 structure. TypeScript types regenerated successfully. No JSON syntax errors. EDL schema supports versioning via self-referential relation. Render job schema tracks BullMQ integration.
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All four schema files exist in correct directories
- [ ] `pnpm strapi ts:generate-types` succeeds without errors
- [ ] TypeScript types generated in `types/generated/` include RecordingSession, MediaAsset, EditDecisionList, RenderJob
- [ ] All schemas have proper collectionName, info, attributes
- [ ] All relation fields have inversedBy defined
- [ ] All status enumerations have appropriate states
- [ ] No JSON syntax errors in any schema file
</verification>

<success_criteria>

- All four Strapi content type schemas created following v5 patterns
- TypeScript types regenerated successfully
- Relations properly defined with inversedBy
- Status fields indexed for query performance
- JSON fields used for complex structured data (offsets, EDL, metadata)
- Versioned EDL workflow supported via parentVersion relation
- Render job integration with BullMQ via bullmq_job_id field
- Deterministic rendering supported via versionHash field
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/08-recording-session-data-model/08-01-SUMMARY.md`:

---
phase: 08-recording-session-data-model
plan: 01
subsystem: strapi-schemas
requires: []
provides: [recording-session-schema, media-asset-schema, edit-decision-list-schema, render-job-schema]
affects: [09, 10, 11, 12, 13]
tags: [data-model, strapi, multi-camera, v2.0]
tech-stack:
  added: [recording-session content-type, media-asset content-type, edit-decision-list content-type, render-job content-type]
  patterns: [Strapi v5 schema structure, versioned EDL via self-referential relations, BullMQ job tracking]
key-decisions:
  - "recording-session groups 3+ angles with sync offsets stored as JSON"
  - "media-asset tracks original/proxy/mezzanine URLs for multi-resolution workflow"
  - "edit-decision-list supports versioning via parentVersion self-referential relation"
  - "render-job integrates with BullMQ via bullmq_job_id field"
  - "versionHash field enables deterministic rendering"
key-files: [ruach-ministries-backend/src/api/recording-session/content-types/recording-session/schema.json, ruach-ministries-backend/src/api/media-asset/content-types/media-asset/schema.json, ruach-ministries-backend/src/api/edit-decision-list/content-types/edit-decision-list/schema.json, ruach-ministries-backend/src/api/render-job/content-types/render-job/schema.json]
patterns-established:
  - "Multi-camera session data model with sync offset storage"
  - "Versioned EDL workflow with parent/child relations"
  - "Render job tracking with BullMQ integration"
---

# Phase 8 Plan 1: Recording Session Data Model Summary

**Established data foundation for multi-camera video production pipeline with four content types supporting 3+ angles, versioned EDLs, and render orchestration.**

## Accomplishments

- Created recording-session schema: Groups 3+ camera angles, stores sync offsets, tracks workflow state
- Created media-asset schema: Tracks original/proxy/mezzanine URLs for each angle with technical metadata
- Created edit-decision-list schema: Supports versioned EDL workflow with parent/child relations
- Created render-job schema: Integrates with BullMQ job queue for render orchestration
- All schemas follow Strapi v5 patterns with proper relations, indexes, and validation
- TypeScript types regenerated successfully

## Files Created/Modified

- `ruach-ministries-backend/src/api/recording-session/content-types/recording-session/schema.json` - Session grouping and sync data
- `ruach-ministries-backend/src/api/media-asset/content-types/media-asset/schema.json` - Multi-resolution media asset tracking
- `ruach-ministries-backend/src/api/edit-decision-list/content-types/edit-decision-list/schema.json` - Versioned EDL storage
- `ruach-ministries-backend/src/api/render-job/content-types/render-job/schema.json` - Render job queue integration
- TypeScript types regenerated in `types/generated/`

## Decisions Made

1. **Sync offsets stored as JSON** - `{A: 0, B: 1830, C: -420}` format enables flexible multi-angle sync
2. **Three URL types per asset** - original (raw), proxy (preview), mezzanine (rendering) support efficient workflows
3. **Versioned EDL via self-referential relations** - parentVersion/childVersions enable v1 AI → v2 human → v3 final workflow
4. **BullMQ integration via bullmq_job_id** - Direct link to async job queue for render orchestration
5. **versionHash for deterministic rendering** - SHA256 of edlData ensures reproducible renders

## Issues Encountered

None

## Next Phase Readiness

Phase 9 (Media Ingestion & Sync) can proceed:
- recording-session schema supports sync offset storage (requirement for Phase 9b)
- media-asset schema tracks original/proxy/mezzanine URLs (requirement for Phase 9a)
- Separation of normalization from sync supported by distinct URL fields

Phase 10 (Transcript Integration) can proceed:
- recording-session has oneToOne relation to library-transcription (existing)
- Master transcript can be linked to session via this relation

Phase 11 (AI Edit Decision List) can proceed:
- edit-decision-list schema supports versioned workflow
- edlData JSON field ready for AI-generated cuts/overlays/chapters/shorts

Phase 12 (Remotion Renderer) can proceed:
- render-job schema tracks format (full_16_9, short_9_16, clip_1_1, thumbnail)
- Links to edl for deterministic rendering from EDL + assets + versionHash

Phase 13 (Studio Operator UI) can proceed:
- All schemas have status enumerations for workflow state tracking
- Relations enable full session → assets → EDL → renders query paths
</output>
