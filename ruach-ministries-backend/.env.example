# ==============================================================================
# STRAPI BACKEND ENVIRONMENT VARIABLES
# ==============================================================================

# ------------------------------------------------------------------------------
# Core Strapi Configuration
# ------------------------------------------------------------------------------

NODE_ENV=development
HOST=0.0.0.0
PORT=1337

# Public URLs
API_URL=http://localhost:1337
PUBLIC_URL=http://localhost:3000

# ------------------------------------------------------------------------------
# Security & Authentication
# ------------------------------------------------------------------------------

# JWT Secret (REQUIRED)
# CRITICAL: Must be a cryptographically secure random string (32+ characters)
# Generate using: openssl rand -base64 32
# NEVER commit the actual secret to version control
# NEVER use the same secret across environments
JWT_SECRET=REPLACE_WITH_RANDOM_STRING_FROM_openssl_rand_base64_32

# Admin JWT Secret (REQUIRED)
# Separate from user JWT for admin panel authentication
# Generate using: openssl rand -base64 32
ADMIN_JWT_SECRET=REPLACE_WITH_RANDOM_STRING_FROM_openssl_rand_base64_32

# App Keys (REQUIRED)
# Comma-separated list of app encryption keys (minimum 2 keys)
# Generate using: openssl rand -base64 32 (run twice)
# Example: "key1,key2"
APP_KEYS=REPLACE_WITH_KEY1,REPLACE_WITH_KEY2

# API Token Salt (REQUIRED)
# Used for API token generation
# Generate using: openssl rand -base64 32
API_TOKEN_SALT=REPLACE_WITH_RANDOM_STRING_FROM_openssl_rand_base64_32

# Transfer Token Salt (REQUIRED)
# Used for transfer token generation
# Generate using: openssl rand -base64 32
TRANSFER_TOKEN_SALT=REPLACE_WITH_RANDOM_STRING_FROM_openssl_rand_base64_32

# Cookie Security (RECOMMENDED)
# Controls whether refresh tokens are sent over HTTPS only
# - Set to "true" in production (requires HTTPS)
# - Set to "false" in local development (HTTP allowed)
# - If not set, defaults to NODE_ENV=production check
# IMPORTANT: In production, ensure this is set to "true" or NODE_ENV is "production"
COOKIE_SECURE=false

# Revalidation Secret (REQUIRED if using Next.js revalidation)
# Shared secret between Strapi and Next.js for on-demand ISR
# Must match STRAPI_REVALIDATE_SECRET in Next.js .env
# Generate using: openssl rand -base64 32
REVALIDATE_SECRET=REPLACE_WITH_RANDOM_STRING_FROM_openssl_rand_base64_32

# Preview Feature Configuration (REQUIRED for Preview feature)
# Client URL - Frontend application URL for preview feature
# Must match the domain where your Next.js app is running
CLIENT_URL=http://localhost:3000

# Preview Secret (REQUIRED for Next.js draft mode)
# Shared secret between Strapi and Next.js for preview authentication
# Must match PREVIEW_SECRET in Next.js .env
# Generate using: openssl rand -base64 32
PREVIEW_SECRET=REPLACE_WITH_RANDOM_STRING_FROM_openssl_rand_base64_32

# ------------------------------------------------------------------------------
# Database Configuration
# ------------------------------------------------------------------------------

# SQLite (Development - Default)
DATABASE_CLIENT=sqlite
DATABASE_FILENAME=.tmp/data.db

# PostgreSQL (Production - Recommended)
# Uncomment and configure for production use:
# DATABASE_CLIENT=postgres
# DATABASE_HOST=localhost
# DATABASE_PORT=5432
# DATABASE_NAME=strapi
# DATABASE_USERNAME=strapi
# DATABASE_PASSWORD=SECURE_PASSWORD
# DATABASE_SSL=false

# ------------------------------------------------------------------------------
# Redis Configuration (REQUIRED for Phase 13 Render Worker)
# ------------------------------------------------------------------------------

# Standard Redis Connection (for BullMQ queue, caching)
# REQUIRED: Phase 13 render worker needs Redis for job queue
# Digital Ocean: Use Managed Redis or Docker container
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
# Or use Redis URL:
# REDIS_URL=redis://localhost:6379

# Upstash Redis (Serverless alternative for token storage & rate limiting)
# Get credentials from: https://upstash.com/
UPSTASH_REDIS_REST_URL=
UPSTASH_REDIS_REST_TOKEN=

# Digital Ocean Redis Setup:
# Option 1: Managed Redis (Recommended for production)
#   - Create managed Redis cluster in DO dashboard
#   - Use connection string: redis://username:password@host:port
# Option 2: Self-hosted via Docker
#   - docker run -d -p 6379:6379 redis:alpine
# Option 3: Redis Cloud (Upstash/Redis Labs)
#   - Free tier available, fully managed

# ------------------------------------------------------------------------------
# Email Configuration
# ------------------------------------------------------------------------------

# Email Provider (Resend recommended)
EMAIL_PROVIDER=resend
EMAIL_PROVIDER_OPTIONS_API_KEY=
# Or use env var:
RESEND_API_KEY=

# Default email sender
EMAIL_DEFAULT_FROM=noreply@example.com
EMAIL_DEFAULT_REPLY_TO=hello@example.com

# ------------------------------------------------------------------------------
# Logging & Monitoring
# ------------------------------------------------------------------------------

# Log Level: error, warn, info, debug
LOG_LEVEL=info

# Logtail (BetterStack) - Production logging
LOGTAIL_SOURCE_TOKEN=

# ------------------------------------------------------------------------------
# Social Media Publishing (Ruach Publisher Plugin)
# ------------------------------------------------------------------------------

# YouTube Configuration
YOUTUBE_CLIENT_ID=
YOUTUBE_CLIENT_SECRET=
YOUTUBE_REDIRECT_URI=http://localhost:1337/api/youtube/callback
YOUTUBE_REFRESH_TOKEN=
YOUTUBE_DEFAULT_PRIVACY=public

# Facebook Configuration
FACEBOOK_PAGE_ACCESS_TOKEN=
FACEBOOK_PAGE_ID=
FACEBOOK_API_VERSION=v18.0

# Instagram Configuration (uses Facebook Graph API)
INSTAGRAM_BUSINESS_ACCOUNT_ID=
# Uses FACEBOOK_PAGE_ACCESS_TOKEN from above

# X (Twitter) Configuration
X_API_BEARER_TOKEN=

# Truth Social Configuration
TRUTH_SOCIAL_ACCESS_TOKEN=

# Patreon Configuration
PATREON_ACCESS_TOKEN=
PATREON_CAMPAIGN_ID=

# Locals Configuration
LOCALS_AUTH_TOKEN=

# Rumble Configuration
RUMBLE_API_KEY=

# ------------------------------------------------------------------------------
# Payment Processing (Stripe)
# ------------------------------------------------------------------------------

STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
# Role names for subscription management
STRIPE_ACTIVE_ROLE_NAME=Partner
STRIPE_FALLBACK_ROLE_NAME=Authenticated

# ------------------------------------------------------------------------------
# File Upload & Storage
# ------------------------------------------------------------------------------

# Cloudflare R2 / S3-Compatible Storage
# Configure in Strapi admin panel or via plugins config

# ------------------------------------------------------------------------------
# Phase 13: Render Pipeline Configuration
# ------------------------------------------------------------------------------

# Cloudflare R2 Storage (REQUIRED for Phase 13 render artifacts)
# Get these from Cloudflare R2 dashboard → API Tokens
# 1. Create R2 bucket in Cloudflare dashboard
# 2. Generate API token with read/write permissions
# 3. Configure custom domain (optional) for public access
R2_ACCOUNT_ID=your-account-id                      # Cloudflare account ID
R2_ACCESS_KEY_ID=your-access-key                   # R2 API token access key
R2_SECRET_ACCESS_KEY=your-secret-key               # R2 API token secret
R2_BUCKET_NAME=ruach-renders                       # R2 bucket name
R2_PUBLIC_DOMAIN=renders.ruachstudios.com          # Optional: custom domain for public URLs

# Render Worker Control (REQUIRED for Phase 13)
# Controls whether the background render worker starts with Strapi
# - Set to "true" or omit for normal operation (worker enabled)
# - Set to "false" to disable worker (useful for admin-only instances)
# Digital Ocean: Keep enabled on app instances, disable on admin panel instances
ENABLE_RENDER_WORKER=true

# ------------------------------------------------------------------------------
# CORS Configuration
# ------------------------------------------------------------------------------

# Allowed origins (comma-separated)
# Example: http://localhost:3000,https://yoursite.com
# Leave empty to use default Next.js origin

# ------------------------------------------------------------------------------
# Admin Panel Configuration
# ------------------------------------------------------------------------------

# Admin panel URL (if different from API_URL)
# ADMIN_URL=http://localhost:1337/admin

# ------------------------------------------------------------------------------
# AI & RECOMMENDATIONS (Phase 4)
# ------------------------------------------------------------------------------

# API Keys (replace with production secrets)
OPENAI_API_KEY=sk-proj-REPLACE_ME
ANTHROPIC_API_KEY=sk-ant-REPLACE_ME

# Frontend Feature Flags (mirrors Next.js .env.production)
NEXT_PUBLIC_AI_ASSISTANT_ENABLED=true
NEXT_PUBLIC_RECOMMENDATIONS_ENABLED=true
NEXT_PUBLIC_SEMANTIC_SEARCH_ENABLED=false
AI_ASSISTANT_MAX_HISTORY=20
RECOMMENDATIONS_CACHE_TTL=3600

# ------------------------------------------------------------------------------
# Canon Audit System (Notion Integration)
# ------------------------------------------------------------------------------

# Notion API Key (REQUIRED for canon audit)
# 1. Create integration at https://www.notion.so/my-integrations
# 2. Copy the "Internal Integration Token"
# 3. Share your database with the integration
NOTION_API_KEY=

# Notion Database ID (REQUIRED for canon audit)
# Found in database URL: https://www.notion.so/{workspace}/{database_id}?v={view_id}
NOTION_DATABASE_ID=

# ------------------------------------------------------------------------------
# Video Render Rate Limits
# ------------------------------------------------------------------------------
# Protects AWS Lambda from abuse with user-based rate limiting
VIDEO_RENDER_MAX_RENDERS=5          # Max renders per user per window
VIDEO_RENDER_WINDOW_SECONDS=900     # 15 minutes
VIDEO_STATUS_MAX_REQUESTS=100       # Max status checks per minute
VIDEO_STATUS_WINDOW_SECONDS=60      # 1 minute

# ------------------------------------------------------------------------------
# Remotion Lambda Configuration
# ------------------------------------------------------------------------------
# AWS region where Lambda function is deployed
REMOTION_AWS_REGION=us-east-1

# Lambda function name (from pnpm lambda:deploy output)
REMOTION_FUNCTION_NAME=remotion-render-4-0-415-mem2048mb-disk2048mb-120sec

# Site URL (from pnpm lambda:sites output)
REMOTION_SERVE_URL=https://remotionlambda-useast1-8fzjwoqri3.s3.us-east-1.amazonaws.com/sites/jly5b182dg/index.html

# Site name for redeployment
REMOTION_SITE_NAME=jly5b182dg

# AWS credentials (uses AWS CLI credentials from ~/.aws/credentials by default)
# Only set these if you need to override the default credential chain:
# AWS_ACCESS_KEY_ID=your-access-key-id
# AWS_SECRET_ACCESS_KEY=your-secret-access-key

# ------------------------------------------------------------------------------
# Production Checklist
# ------------------------------------------------------------------------------
# Before deploying to production:
#
# Core Security:
# [ ] Generate unique JWT_SECRET (32+ characters)
# [ ] Generate unique ADMIN_JWT_SECRET (32+ characters)
# [ ] Generate unique APP_KEYS (2+ keys)
# [ ] Generate unique API_TOKEN_SALT (32+ characters)
# [ ] Generate unique TRANSFER_TOKEN_SALT (32+ characters)
# [ ] Set COOKIE_SECURE=true (or ensure NODE_ENV=production)
#
# Infrastructure:
# [ ] Configure production database (PostgreSQL recommended)
# [ ] Set up Redis for BullMQ job queue (REQUIRED for Phase 13)
# [ ] Configure Upstash Redis for token storage & rate limiting
# [ ] Enable HTTPS on hosting platform
# [ ] Set up database backups
#
# Phase 13 Render Pipeline:
# [ ] Configure Cloudflare R2 storage (R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, etc.)
# [ ] Create R2 bucket and set CORS policy
# [ ] Set up Redis for render job queue (REQUIRED)
# [ ] Set ENABLE_RENDER_WORKER=true on app instances
# [ ] Test render job creation and processing
# [ ] Verify R2 uploads and artifact URLs
# [ ] Monitor render worker logs for errors
#
# External Services:
# [ ] Configure email provider (Resend recommended)
# [ ] Set up Logtail for production logging
# [ ] Review CORS configuration
# [ ] Configure social media API credentials
# [ ] Set up Stripe for payments
#
# Testing:
# [ ] Test authentication flows
# [ ] Test render job pipeline end-to-end
# [ ] Verify file uploads to R2
# [ ] Test rate limiting
# [ ] Load test Redis connection pool
#
# Digital Ocean Specific:
# [ ] Configure managed PostgreSQL database
# [ ] Set up managed Redis cluster OR deploy Redis container
# [ ] Configure environment variables in App Platform
# [ ] Set up custom domain with SSL
# [ ] Configure health checks (/api/_health)
# [ ] Enable automatic deployments from GitHub
# [ ] Set up log forwarding to Logtail
# [ ] Configure resource scaling (CPU/Memory)
# [ ] Test backup and restore procedures

# ==============================================================================
# DIGITAL OCEAN DEPLOYMENT GUIDE
# ==============================================================================

# Quick Start: Deploy Ruach Backend to Digital Ocean App Platform
#
# 1. Create App Platform App
#    - Go to: https://cloud.digitalocean.com/apps
#    - Click "Create App" → Connect to GitHub repository
#    - Select repository: joinruach/JoinRuach
#    - Set root directory: ruach-ministries-backend
#
# 2. Configure Build Settings
#    - Build Command: pnpm install && pnpm build
#    - Run Command: pnpm start
#    - Environment: Node.js 20.x
#    - Instance Size: Basic (1 GB RAM minimum for render worker)
#
# 3. Set Up Managed Databases
#    A. PostgreSQL Database:
#       - Create managed database cluster
#       - Note connection details (host, port, user, password, database)
#       - Set DATABASE_CLIENT=postgres
#       - Set DATABASE_HOST, DATABASE_PORT, DATABASE_NAME, etc.
#       - Enable DATABASE_SSL=true
#
#    B. Redis Database (REQUIRED for Phase 13):
#       - Create managed Redis cluster
#       - Note connection details (host, port, password)
#       - Set REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
#       - OR use REDIS_URL=redis://username:password@host:port
#
# 4. Configure Environment Variables in App Platform
#    - Go to Settings → Environment Variables
#    - Add ALL required variables from this file
#    - Use "Encrypt" option for secrets (JWT, API keys, passwords)
#    - Set NODE_ENV=production
#    - Set COOKIE_SECURE=true
#
# 5. Set Up Cloudflare R2 for Render Artifacts
#    - Go to Cloudflare R2 dashboard
#    - Create bucket: ruach-renders
#    - Generate API token with read/write permissions
#    - Set R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY
#    - Optional: Configure custom domain (R2_PUBLIC_DOMAIN)
#
# 6. Configure Custom Domain & SSL
#    - Add custom domain in App Platform settings
#    - Update DNS records (CNAME or A record)
#    - SSL certificate auto-provisioned by DO
#    - Update API_URL and PUBLIC_URL to production domains
#
# 7. Deploy & Verify
#    - Trigger deployment from GitHub main branch
#    - Monitor build logs for errors
#    - Check health endpoint: https://your-domain.com/_health
#    - Verify Strapi admin loads: https://your-domain.com/admin
#    - Test render job creation and processing
#    - Verify R2 artifact uploads
#
# 8. Monitoring & Maintenance
#    - Set up Logtail for centralized logging (LOGTAIL_SOURCE_TOKEN)
#    - Configure database backups (daily recommended)
#    - Monitor Redis memory usage
#    - Set up uptime monitoring (UptimeRobot, Pingdom)
#    - Review render worker logs regularly
#
# Resource Requirements (Phase 13 Render Worker):
#   - CPU: 1 vCPU minimum (2 vCPU recommended)
#   - RAM: 1 GB minimum (2 GB recommended for concurrent renders)
#   - Redis: 256 MB minimum (managed Redis Basic plan)
#   - PostgreSQL: 1 GB RAM minimum
#   - Storage: 10 GB minimum (for temp render files)
#
# Cost Estimation (Digital Ocean):
#   - App Platform (Basic - 1 GB RAM): ~$12/month
#   - Managed PostgreSQL (1 GB RAM): ~$15/month
#   - Managed Redis (256 MB): ~$15/month
#   - Total: ~$42/month + data transfer
#
# Scaling Considerations:
#   - For high render volumes, increase worker instance size
#   - Consider multiple worker instances with shared Redis
#   - Monitor BullMQ queue depth and processing times
#   - Scale Redis vertically for better queue performance
#
# Troubleshooting:
#   - Worker not processing jobs? Check ENABLE_RENDER_WORKER=true
#   - Redis connection errors? Verify REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
#   - R2 upload failures? Check R2 credentials and bucket permissions
#   - Out of memory errors? Increase instance size or reduce concurrency
#   - Slow renders? Check Remotion CLI timeout and Lambda configuration
